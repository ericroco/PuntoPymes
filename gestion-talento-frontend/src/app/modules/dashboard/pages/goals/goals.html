<div class="page-container goals-page">

  <div *ngIf="!can(P.PERFORMANCE_MANAGE)" @listAnimation>

    <header class="page-header">
      <div class="header-text">
        <h2>Metas y Objetivos</h2>
        <p class="subtitle">Gestiona tu progreso y el de tu equipo para este ciclo.</p>

        <div *ngIf="!activeCycleId" class="cycle-warning">
          <mat-icon>warning_amber</mat-icon> No hay ciclo de evaluación activo
        </div>
      </div>

      <button mat-flat-button color="primary" (click)="openCreateGoalDialog()" [disabled]="!activeCycleId">
        <mat-icon>add</mat-icon> Nueva Meta Personal
      </button>
    </header>

    <mat-tab-group animationDuration="0ms" class="custom-tabs">

      <mat-tab>
        <ng-template mat-tab-label>
          <div class="tab-label-content">
            <mat-icon class="tab-icon">flag</mat-icon> <span>Mis Metas</span>
          </div>
        </ng-template>

        <div class="tab-content-wrapper">
          <div class="goals-grid" *ngIf="myGoals.length > 0; else emptyPersonal">

            <div *ngFor="let goal of myGoals" class="goal-card"
              [ngClass]="goal.progreso === 100 ? 'status-complete' : 'status-progress'">

              <div class="card-header">
                <div class="header-top">
                  <span class="date-badge">Asignada: {{ goal.createdAt | date:'dd MMM' }}</span>
                  <button mat-icon-button [matMenuTriggerFor]="menu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="openUpdateProgressDialog(goal)" [disabled]="goal.progreso === 100">
                      <mat-icon>edit</mat-icon> Actualizar
                    </button>
                  </mat-menu>
                </div>
                <h3>{{ goal.descripcion }}</h3>
              </div>

              <div class="card-body">
                <div class="progress-section">
                  <div class="progress-labels">
                    <span class="percent">{{ goal.progreso }}%</span>
                    <span class="status-text">{{ goal.progreso === 100 ? 'Finalizada' : 'En curso' }}</span>
                  </div>
                  <mat-progress-bar mode="determinate" [value]="goal.progreso"
                    [class.bar-complete]="goal.progreso === 100">
                  </mat-progress-bar>
                </div>
              </div>

              <div class="card-footer">
                <button mat-stroked-button color="primary" class="full-width-btn"
                  (click)="openUpdateProgressDialog(goal)" [disabled]="goal.progreso === 100">
                  {{ goal.progreso === 100 ? 'Completada' : 'Actualizar Avance' }}
                </button>
              </div>
            </div>

          </div>

          <ng-template #emptyPersonal>
            <div class="empty-state">
              <div class="icon-wrapper"><mat-icon>flag</mat-icon></div>
              <h3>Sin metas asignadas</h3>
              <p>Aún no tienes metas personales para el ciclo actual.</p>
            </div>
          </ng-template>
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <div class="tab-label-content">
            <mat-icon class="tab-icon">groups</mat-icon> <span>Mi Equipo</span>
          </div>
        </ng-template>

        <div class="tab-content-wrapper">
          <div class="goals-grid" *ngIf="deptGoals.length > 0; else emptyDept">
            <div *ngFor="let goal of deptGoals" class="goal-card type-dept">
              <div class="card-header">
                <div class="dept-badge">
                  <mat-icon>domain</mat-icon> Objetivo Grupal
                </div>
                <h3>{{ goal.descripcion }}</h3>
              </div>
              <div class="card-body">
                <div class="progress-section">
                  <div class="progress-labels">
                    <span class="percent">{{ goal.progreso }}%</span>
                    <span class="status-text">Avance del Equipo</span>
                  </div>
                  <mat-progress-bar mode="determinate" color="accent" [value]="goal.progreso"></mat-progress-bar>
                </div>
              </div>
            </div>
          </div>
          <ng-template #emptyDept>
            <div class="empty-state">
              <div class="icon-wrapper"><mat-icon>groups_2</mat-icon></div>
              <h3>Sin metas grupales</h3>
              <p>No hay objetivos departamentales definidos.</p>
            </div>
          </ng-template>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>


  <div *ngIf="can(P.PERFORMANCE_MANAGE)" class="admin-view">

    <header class="page-header">
      <div class="header-text">
        <h2>Gestión de Metas</h2>
        <p class="subtitle">Administración global de objetivos y KPIs.</p>
      </div>
      <button mat-flat-button color="primary" (click)="openCreateGoalDialog()">
        <mat-icon>add</mat-icon> Asignar Meta
      </button>
    </header>

    <mat-tab-group animationDuration="0ms" class="custom-tabs">

      <mat-tab label="Dashboard">
        <div class="dashboard-content" @listAnimation>

          <div class="kpi-grid">
            <div class="kpi-card">
              <span class="kpi-label">Total Metas</span>
              <span class="kpi-value">{{ teamGoalProgress.total }}</span>
              <mat-icon class="kpi-icon">list_alt</mat-icon>
            </div>
            <div class="kpi-card success">
              <span class="kpi-label">Completadas</span>
              <span class="kpi-value">{{ teamGoalProgress.completed }}</span>
              <mat-icon class="kpi-icon">check_circle</mat-icon>
            </div>
            <div class="kpi-card info">
              <span class="kpi-label">En Progreso</span>
              <span class="kpi-value">{{ teamGoalProgress.onTrack }}</span>
              <mat-icon class="kpi-icon">trending_up</mat-icon>
            </div>
          </div>

          <div class="chart-section mat-elevation-z1">
            <div class="section-header">
              <h3>Desempeño Global del Equipo</h3>
            </div>
            <div class="chart-container">
              <ngx-charts-bar-vertical [results]="performanceDistributionData" [xAxis]="true" [yAxis]="true"
                [showXAxisLabel]="false" [showYAxisLabel]="true" [scheme]="chartColorScheme" [legend]="false"
                [barPadding]="20">
              </ngx-charts-bar-vertical>
            </div>
          </div>

        </div>
      </mat-tab>

      <mat-tab label="Metas por Departamento">
        <div class="tab-content-wrapper">

          <div class="goals-grid" *ngIf="adminDeptGoals.length > 0; else emptyAdminDept">
            <div *ngFor="let goal of adminDeptGoals" class="goal-card type-dept">

              <div class="card-header">
                <div class="dept-badge">
                  <mat-icon>domain</mat-icon> {{ goal.departamento?.nombre || 'General' }}
                </div>
                <h3>{{ goal.descripcion }}</h3>
              </div>

              <div class="card-body">
                <div class="progress-section">
                  <div class="progress-labels">
                    <span class="percent">{{ goal.progreso }}%</span>
                    <span class="status-text">Avance</span>
                  </div>
                  <mat-progress-bar mode="determinate" color="accent" [value]="goal.progreso"></mat-progress-bar>
                </div>
              </div>

              <div class="card-footer">
                <button mat-stroked-button color="accent" class="full-width-btn"
                  (click)="openUpdateProgressDialog(goal)">
                  <mat-icon>settings</mat-icon> Gestionar Avance
                </button>
              </div>

            </div>
          </div>

          <ng-template #emptyAdminDept>
            <div class="empty-state">
              <div class="icon-wrapper"><mat-icon>domain_disabled</mat-icon></div>
              <h3>Sin metas departamentales</h3>
              <p>No se han creado objetivos por área en este ciclo.</p>
            </div>
          </ng-template>

        </div>
      </mat-tab>

      <mat-tab label="Gestión Global">
        <div class="list-wrapper mat-elevation-z2">

          <div class="list-header">
            <div class="col-title">Título</div>
            <div class="col-assignee">Asignado a</div>
            <div class="col-progress">Progreso</div>
            <div class="col-status">Estado</div>
            <div class="col-actions"></div>
          </div>

          <div class="list-body">
            <div *ngFor="let goal of allGoalsTable.dataSource" class="list-row" @listAnimation>

              <div class="col-title font-500">{{ goal.title }}</div>

              <div class="col-assignee">
                <div class="user-chip" [class.is-dept]="goal.assigneeName.includes('Depto')">
                  <mat-icon>{{ goal.assigneeName.includes('Depto') ? 'domain' : 'person' }}</mat-icon>
                  {{ goal.assigneeName }}
                </div>
              </div>

              <div class="col-progress">
                <div class="progress-compact">
                  <mat-progress-bar mode="determinate" [value]="goal.progress"></mat-progress-bar>
                  <span>{{ goal.progress }}%</span>
                </div>
              </div>

              <div class="col-status">
                <span class="status-pill"
                  [ngClass]="goal.status === 'Completada' ? 'status-aprobado' : 'status-pendiente'">
                  {{ goal.status }}
                </span>
              </div>

              <div class="col-actions">
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <button mat-menu-item (click)="openAdminEdit(goal)">
                    <mat-icon>edit</mat-icon> Editar
                  </button>
                  <button mat-menu-item (click)="deleteGoal(goal)">
                    <mat-icon color="warn">delete</mat-icon> Eliminar
                  </button>
                </mat-menu>
              </div>

            </div>

            <div *ngIf="allGoalsTable.dataSource.length === 0 && !isLoading" class="empty-state-table">
              <mat-icon>search_off</mat-icon>
              <p>No se encontraron metas en este ciclo.</p>
            </div>
          </div>

        </div>
      </mat-tab>

    </mat-tab-group>
  </div>

</div>