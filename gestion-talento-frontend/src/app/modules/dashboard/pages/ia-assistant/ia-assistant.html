<div class="chat-layout">
    <app-subpage-header title="Asistente Virtual RRHH" subtitle="Consulta normativas internas con IA" icon="smart_toy">
    </app-subpage-header>

    <div class="chat-card">

        <div class="chat-messages" #scrollContainer>

            <div class="empty-state" *ngIf="messages.length === 0">
                <div class="brand-avatar-lg">
                    <mat-icon>psychology</mat-icon>
                </div>

                <div class="welcome-text">
                    <h3>¡Hola! Soy tu asistente de RRHH</h3>
                    <p>Selecciona un tema o escribe tu consulta:</p>
                </div>

                <div class="suggestions-container">
                    <button class="suggestion-chip" (click)="askSuggestion('¿Cuántos días de vacaciones tengo?')">
                        <div class="icon-box"><mat-icon>beach_access</mat-icon></div>
                        <span>Vacaciones</span>
                    </button>

                    <button class="suggestion-chip" (click)="askSuggestion('¿Cómo solicito un permiso?')">
                        <div class="icon-box"><mat-icon>event_available</mat-icon></div>
                        <span>Permisos</span>
                    </button>

                    <button class="suggestion-chip" (click)="askSuggestion('¿Cuál es el código de vestimenta?')">
                        <div class="icon-box"><mat-icon>checkroom</mat-icon></div>
                        <span>Vestimenta</span>
                    </button>

                    <button class="suggestion-chip" (click)="askSuggestion('¿Cómo reporto una incidencia?')">
                        <div class="icon-box"><mat-icon>report_problem</mat-icon></div>
                        <span>Incidencias</span>
                    </button>
                </div>
            </div>

            <ng-container *ngFor="let msg of messages">
                <div class="msg-row" [class.msg-user]="msg.sender === 'user'" [class.msg-ai]="msg.sender === 'ai'"
                    [@messageAnimation]>

                    <div class="msg-avatar" *ngIf="msg.sender === 'ai'">
                        <mat-icon>smart_toy</mat-icon>
                    </div>

                    <div class="msg-bubble">
                        <div class="msg-content" [innerHTML]="msg.text"></div>
                        <span class="msg-time">{{ msg.time | date:'shortTime' }}</span>
                    </div>
                </div>
            </ng-container>

            <div class="msg-row msg-ai" *ngIf="isLoading">
                <div class="msg-avatar">
                    <mat-icon>smart_toy</mat-icon>
                </div>
                <div class="msg-bubble loading-bubble">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>

        </div>

        <div class="chat-footer">
            <mat-form-field appearance="outline" class="clean-input">
                <mat-label>Escribe tu consulta...</mat-label>
                <textarea matInput [(ngModel)]="newMessage" (keydown.enter)="handleEnterKey($event)"
                    [disabled]="isLoading" cdkTextareaAutosize cdkAutosizeMinRows="1" cdkAutosizeMaxRows="4"></textarea>

                <button mat-icon-button matSuffix (click)="sendMessage()" [disabled]="!newMessage.trim() || isLoading"
                    color="primary">
                    <mat-icon>{{ isLoading ? 'stop' : 'send' }}</mat-icon>
                </button>
            </mat-form-field>

            <div class="legal-text">
                IA en fase beta. Verifica datos críticos con RRHH.
            </div>
        </div>
    </div>
</div>