<div class="page-container">

  <header class="page-header">
    <div>
      <h2>Nómina y Salarios</h2>
    </div>

    <div class="header-actions">

      <button *ngIf="can(P.PAYROLL_PROCESS)" class="btn btn-secondary" [disabled]="selection.isEmpty()"
        (click)="openBulkAddItemDialog()">
        <mat-icon>library_add</mat-icon>
        <span>Registrar Novedad ({{ selection.selected.length }})</span>
      </button>

      <button *ngIf="can(P.PAYROLL_PROCESS)" class="btn btn-primary" (click)="openProcessDialog()">
        <mat-icon>settings_suggest</mat-icon>
        Generar Rol
      </button>

      <button *ngIf="can(P.PAYROLL_EXPORT)" class="btn btn-secondary" [matMenuTriggerFor]="menuExport"
        [disabled]="!lastProcessedPeriodId">
        <mat-icon>file_download</mat-icon> Exportar Reportes
      </button>

      <mat-menu #menuExport="matMenu">
        <button mat-menu-item (click)="exportGeneralReport(lastProcessedPeriodId!)">
          <mat-icon>table_view</mat-icon>
          <span>Reporte General (Excel/CSV)</span>
        </button>

        <button mat-menu-item (click)="exportIndividualPayslips(lastProcessedPeriodId!)">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>Roles Individuales (PDF)</span>
        </button>
      </mat-menu>

    </div>
  </header>

  <div class="filter-bar">
    <mat-form-field appearance="outline" class="filter-field search-field">
      <mat-label>Buscar por Nombre, Cédula o Cargo</mat-label>
      <input matInput [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Departamento</mat-label>
      <mat-select [(ngModel)]="selectedDepartment" (ngModelChange)="applyFilters()">
        <mat-option value="todos">Todos los Departamentos</mat-option>
        <mat-option *ngFor="let dept of departments" [value]="dept">{{ dept }}</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="table-container mat-elevation-z2">
    <table>
      <thead>
        <tr>
          <th class="checkbox-col">
            <mat-checkbox (change)="$event ? toggleAllRows() : null" [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()">
            </mat-checkbox>
          </th>

          <th>Empleado</th>
          <th>Identificación</th>
          <th>Cargo</th>
          <th>Departamento</th>

          <th>Salario Base</th>

          <th>Fecha Ingreso</th>
          <th class="actions">Acciones</th>
        </tr>
      </thead>

      <tbody *ngIf="filteredEmployees.length > 0; else noEmployees">
        <tr *ngFor="let employee of filteredEmployees" [class.selected-row]="selection.isSelected(employee)">

          <td class="checkbox-col">
            <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(employee) : null"
              [checked]="selection.isSelected(employee)">
            </mat-checkbox>
          </td>

          <td><strong>{{ employee.name }}</strong></td>
          <td>{{ employee.nroIdentificacion }}</td>
          <td>{{ employee.role }}</td>
          <td>{{ employee.department }}</td>

          <td class="salary">{{ employee.salary | currency:'USD':'symbol':'1.2-2' }}</td>

          <td>{{ employee.lastRevision | date:'dd MMM, yyyy' }}</td>

          <td class="actions">
            <button class="btn-icon" [routerLink]="['/dashboard/employee', employee.id]" matTooltip="Ver Perfil">
              <mat-icon>visibility</mat-icon>
            </button>

            <button *ngIf="can(P.PAYROLL_PROCESS)" class="btn-icon btn-primary" (click)="openAddItemDialog(employee)"
              matTooltip="Agregar Novedad">
              <mat-icon>add_circle</mat-icon>
            </button>
          </td>
        </tr>
      </tbody>

      <tfoot *ngIf="filteredEmployees.length > 0">
        <tr>
          <td [colSpan]="5" class="total-label">Total Nómina Mensual (Proyección):</td>
          <td class="total-value">
            {{ totals.totalSalary | currency:'USD':'symbol':'1.2-2' }}
          </td>
          <td [colSpan]="2">({{ totals.count }} empleados)</td>
        </tr>
      </tfoot>
    </table>

    <ng-template #noEmployees>
      <div class="no-data-placeholder">
        <mat-icon>search_off</mat-icon>
        <p>No se encontraron empleados con los filtros aplicados.</p>
      </div>
    </ng-template>
  </div>
</div>