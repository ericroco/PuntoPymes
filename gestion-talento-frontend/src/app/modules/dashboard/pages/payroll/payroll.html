<div class="page-container">
  <header class="page-header">
    <h2>Nómina y Salarios</h2>
    <div class="header-actions">
      <button class="btn btn-secondary bulk-action-btn" [disabled]="selection.isEmpty()"
        (click)="openBulkAddItemDialog()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path
            d="M7 7a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.41-1.412A6.97 6.97 0 0010 12c-2.31 0-4.438.784-6.131 2.1zM10.75 12a1 1 0 011 1v.75a.75.75 0 001.5 0V13a2.5 2.5 0 00-2.5-2.5h-1.5A2.5 2.5 0 007 13v.75a.75.75 0 001.5 0V13a1 1 0 011-1h.75z" />
        </svg> <span>Registrar Novedad Masiva ({{ selection.selected.length }})</span>
      </button>

      <button class="btn btn-secondary">Exportar a Contabilidad</button>
    </div>
  </header>

  <div class="filter-bar">
    <mat-form-field appearance="outline" class="filter-field search-field">
      <mat-label>Buscar por Nombre o Cargo</mat-label>
      <input matInput [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Departamento</mat-label>
      <mat-select [(ngModel)]="selectedDepartment" (ngModelChange)="applyFilters()">
        <mat-option value="todos">Todos los Departamentos</mat-option>
        <mat-option *ngFor="let dept of departments" [value]="dept">{{ dept }}</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th class="checkbox-col">
            <mat-checkbox (change)="$event ? toggleAllRows() : null" [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()">
            </mat-checkbox>
          </th>
          <th>Nombre del Empleado</th>
          <th>Cargo</th>
          <th>Departamento</th>
          <th>Salario Mensual (USD)</th>
          <th>Última Revisión</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody *ngIf="filteredEmployees.length > 0; else noEmployees">
        <tr *ngFor="let employee of filteredEmployees" [class.selected-row]="selection.isSelected(employee)">
          <td class="checkbox-col">
            <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(employee) : null"
              [checked]="selection.isSelected(employee)" [aria-label]="checkboxLabel(employee)">
            </mat-checkbox>
          </td>
          <td>{{ employee.name }}</td>
          <td>{{ employee.role }}</td>
          <td>{{ employee.department }}</td>
          <td class="salary">{{ employee.salary | currency:'USD':'symbol':'1.2-2' }}</td>
          <td>{{ employee.lastRevision | date:'dd MMM, yyyy' }}</td>
          <td class="actions">
            <button class="btn-icon btn-primary" [routerLink]="['/dashboard/employee', employee.id]"
              title="Ver Historial Salarial">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z"
                  clip-rule="evenodd" />
              </svg>
            </button>
            <button class="btn-icon" title="Registrar Novedad (Bono, etc.)" (click)="openAddItemDialog(employee)">
              ➕
            </button>
          </td>
        </tr>
      </tbody>

      <tfoot *ngIf="filteredEmployees.length > 0">
        <tr>
          <td [colSpan]="4" class="total-label">Totales ({{ totals.count }} empleados mostrados)</td>
          <td class="total-value">{{ totals.totalSalary | currency:'USD':'symbol':'1.2-2' }}</td>
          <td [colSpan]="2"></td>
        </tr>
      </tfoot>
    </table>

    <ng-template #noEmployees>
      <tbody>
        <tr>
          <td [colSpan]="7" class="no-data-placeholder">
            No se encontraron empleados con los filtros aplicados.
          </td>
        </tr>
      </tbody>
    </ng-template>

  </div>
</div>