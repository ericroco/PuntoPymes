<div class="page-container org-page">

  <header class="page-header">
    <div class="header-text">
      <h2>Organigrama Estructural</h2>
      <p class="subtitle">Visualización jerárquica de la organización.</p>
    </div>

    <div class="zoom-controls">
      <button mat-icon-button (click)="zoomOut()" [disabled]="zoomScale <= 0.3" matTooltip="Alejar">
        <mat-icon>remove</mat-icon>
      </button>
      <span class="zoom-label">{{ (zoomScale * 100) | number:'1.0-0' }}%</span>
      <button mat-icon-button (click)="zoomIn()" [disabled]="zoomScale >= 2" matTooltip="Acercar">
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </header>

  <div class="org-chart-container mat-elevation-z1" cdkDrag>
    <div *ngIf="isLoading" class="loading-state">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Construyendo estructura...</p>
    </div>

    <div class="org-chart" [style.transform]="'scale(' + zoomScale + ')'" [style.transform-origin]="'top center'"
      *ngIf="!isLoading">

      <ng-template #nodeTemplate let-node>
        <div class="node-wrapper">

          <div class="node-card" [ngClass]="getNodeClass(node)">

            <div class="avatar-wrapper">

              <img *ngIf="node.fotoUrl" [src]="node.fotoUrl" (error)="node.fotoUrl = null" alt="Avatar">

              <div *ngIf="!node.fotoUrl" class="avatar-placeholder">
                {{ getInitials(node.nombre, node.apellido) }}
              </div>

              <div class="child-indicator" *ngIf="node.children?.length > 0">
                {{ node.children.length }}
              </div>
            </div>

            <div class="node-info">
              <div class="node-name">{{ node.nombre }} {{ node.apellido }}</div>
              <div class="node-role">{{ node.cargo?.nombre || 'Sin Cargo' }}</div>
            </div>

            <button class="toggle-btn" *ngIf="node.children && node.children.length > 0" (click)="toggleNode(node)"
              [class.expanded]="node.expanded">
              <mat-icon>{{ node.expanded ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</mat-icon>
            </button>

          </div>

        </div>

        <ul *ngIf="node.children && node.children.length > 0 && node.expanded" class="fade-in-down">
          <li *ngFor="let child of node.children">
            <ng-container *ngTemplateOutlet="nodeTemplate; context:{$implicit: child}"></ng-container>
          </li>
        </ul>
      </ng-template>

      <ul>
        <li *ngFor="let node of chartData">
          <ng-container *ngTemplateOutlet="nodeTemplate; context:{$implicit: node}"></ng-container>
        </li>
      </ul>

    </div>
  </div>
</div>