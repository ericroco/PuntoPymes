<div class="page-container overview-page">

  <div *ngIf="viewingAsAdmin" class="admin-view" @widgetAnimation>
    <header class="page-header">
      <h2>Vista General - Administrador</h2>
    </header>

    <section class="summary-cards">
      <div *ngFor="let card of adminKPIs" class="card" [ngClass]="'card-' + card.color">
        <div class="card-content">
          <p class="card-title">{{ card.title }}</p>
          <h3 class="card-value">{{ card.value }}</h3>
        </div>
        <div class="card-footer">
          <span class="trend" [class.positive]="card.isPositive" [class.negative]="!card.isPositive">
            {{ card.trend }}
          </span>
        </div>
      </div>
      <div class="card card-orange">
        <div class="card-content">
          <p class="card-title">Aprobaciones Pendientes</p>
          <h3 class="card-value">{{ pendingApprovals.length }}</h3>
        </div>
        <div class="card-footer">
          <span class="details-link">Solicitudes esperando acción</span>
        </div>
      </div>
    </section>

    <mat-divider></mat-divider>

    <div class="overview-grid">
      <mat-card class="overview-widget">
        <mat-card-header>
          <mat-card-title>Aprobaciones Pendientes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-list *ngIf="pendingApprovals.length > 0; else noApprovals">
            <mat-list-item *ngFor="let req of pendingApprovals">
              <mat-icon matListItemIcon>{{ req.type === 'Vacaciones' ? 'beach_access' : 'receipt_long' }}</mat-icon>
              <div matListItemTitle>{{ req.type }}</div>
              <div matListItemLine>{{ req.description }}</div>
              <div matListItemMeta class="approval-actions">
                <button mat-icon-button color="primary" (click)="approveRequest(req.id)" matTooltip="Aprobar">
                  <mat-icon>check_circle_outline</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="rejectRequest(req.id)" matTooltip="Rechazar">
                  <mat-icon>highlight_off</mat-icon>
                </button>
              </div>
            </mat-list-item>
          </mat-list>
          <ng-template #noApprovals>
            <p class="no-data-placeholder">¡No hay solicitudes pendientes!</p>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <mat-card class="overview-widget">
        <mat-card-header>
          <mat-card-title>Última Encuesta</mat-card-title>
          <mat-card-subtitle>{{ surveySummary.latestSurvey }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p><strong>Participación:</strong> {{ surveySummary.participationRate }}%</p>
          <p><strong>Satisfacción General:</strong> {{ surveySummary.overallSatisfaction }} / 5</p>
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-button color="primary" routerLink="/dashboard/surveys">Ver Detalles</button>
        </mat-card-actions>
      </mat-card>
      <mat-card class="overview-widget chart-widget">
        <mat-card-header>
          <mat-card-title>Distribución por Departamento</mat-card-title>
        </mat-card-header>
        <mat-card-content class="chart-container">
          <ngx-charts-pie-chart [results]="employeeDistribution" [labels]="true" [doughnut]="true"
            [scheme]="chartColorScheme" [legend]="false"> </ngx-charts-pie-chart>
        </mat-card-content>
      </mat-card>

      <mat-card class="overview-widget chart-widget">
        <mat-card-header>
          <mat-card-title>Tendencia de Rotación (Últ. Meses)</mat-card-title>
        </mat-card-header>
        <mat-card-content class="chart-container">
          <ngx-charts-line-chart [results]="turnoverTrend" [xAxis]="true" [yAxis]="true" [showXAxisLabel]="false"
            [showYAxisLabel]="false" [autoScale]="true" yAxisLabel="Nº Salidas" [scheme]="chartColorScheme">
          </ngx-charts-line-chart>
        </mat-card-content>
      </mat-card>

      <mat-card class="overview-widget">
        <mat-card-header>
          <mat-card-title>Próximos Eventos / Vencimientos</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-list *ngIf="upcomingEvents.length > 0; else noEvents">
            <mat-list-item *ngFor="let event of upcomingEvents">
              <mat-icon matListItemIcon>event</mat-icon>
              <div matListItemTitle>{{ event.description }}</div>
              <div matListItemLine>{{ event.date | date:'dd MMM, yyyy' }}</div>
            </mat-list-item>
          </mat-list>
          <ng-template #noEvents>
            <p class="no-data-placeholder">No hay eventos próximos.</p>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <mat-card class="overview-widget quick-links-widget">
        <mat-card-header>
          <mat-card-title>Accesos Rápidos</mat-card-title>
        </mat-card-header>
        <mat-card-content class="quick-links-container">
          <button mat-stroked-button routerLink="/dashboard/employees">
            <mat-icon>group</mat-icon> Gestionar Personal
          </button>
          <button mat-stroked-button routerLink="/dashboard/recruitment">
            <mat-icon>work_outline</mat-icon> Ver Vacantes
          </button>
          <button mat-stroked-button routerLink="/dashboard/sprints">
            <mat-icon>assessment</mat-icon> Gestionar Sprints
          </button>
          <button mat-stroked-button routerLink="/dashboard/settings">
            <mat-icon>settings</mat-icon> Ir a Configuración
          </button>
        </mat-card-content>
      </mat-card>

    </div>
  </div>

  <div *ngIf="!viewingAsAdmin" class="employee-view" @widgetAnimation>
    <header class="page-header">
      <h2>Mi Vista General</h2>
    </header>

    <div class="overview-grid employee-grid">

      <mat-card class="overview-widget announcements-widget">
        <mat-card-header>
          <mat-card-title>
            <mat-icon class="icon-header">campaign</mat-icon> Cartelera Digital
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="scrollable-list">
          <div *ngFor="let anuncio of anuncios" class="anuncio-card" [ngClass]="anuncio.prioridad.toLowerCase()">
            <div class="anuncio-top">
              <span class="badge">{{ anuncio.prioridad }}</span>
              <span class="date">{{ anuncio.createdAt | date:'dd MMM' }}</span>
            </div>
            <h4>{{ anuncio.titulo }}</h4>
            <p>{{ anuncio.contenido }}</p>
          </div>
          <p *ngIf="anuncios.length === 0" class="no-data-placeholder">No hay anuncios nuevos.</p>
        </mat-card-content>
      </mat-card>

      <mat-card class="overview-widget polls-widget">
        <mat-card-header>
          <mat-card-title>
            <div class="title-with-badge">
              <span><mat-icon class="icon-header">poll</mat-icon> Tu Opinión</span>
              <span class="badge-count" *ngIf="encuestasPendientes.length > 0">
                {{ encuestasPendientes.length }}
              </span>
            </div>
          </mat-card-title>

          <mat-card-subtitle *ngIf="encuestasPendientes.length > 0">
            Encuestas por responder
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div *ngIf="encuestasPendientes.length > 0; else noPolls">
            <div class="poll-preview">

              <h5 class="poll-title">{{ encuestasPendientes[0].titulo }}</h5>

              <p class="poll-desc" *ngIf="encuestasPendientes[0].descripcion">
                {{ encuestasPendientes[0].descripcion }}
              </p>

              <div class="actions">
                <button mat-flat-button color="primary" (click)="openVoteDialog(encuestasPendientes[0])">
                  Participar ahora
                </button>
              </div>

              <div class="queue-info" *ngIf="encuestasPendientes.length > 1">
                <small>⚠️ Tienes {{ encuestasPendientes.length - 1 }} más en espera.</small>
              </div>
            </div>
          </div>

          <ng-template #noPolls>
            <div class="empty-state">
              <mat-icon class="empty-icon">check_circle_outline</mat-icon>
              <p class="no-data-placeholder">¡Estás al día! No tienes encuestas pendientes.</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <mat-card class="overview-widget kpi-widget">
        <mat-card-header>
          <mat-card-title>Mis Indicadores</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngFor="let kpi of employeeKPIs" class="kpi-item">
            <label>{{ kpi.title }}</label>
            <span class="kpi-value">{{ kpi.value }}<span *ngIf="kpi.unit !== '%'"> {{ kpi.unit }}</span><span
                *ngIf="kpi.unit === '%'">%</span></span>
            <mat-progress-bar *ngIf="kpi.unit === '%'" mode="determinate" [value]="kpi.value"></mat-progress-bar>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="overview-widget">
        <mat-card-header>
          <mat-card-title>Solicitar Vacaciones</mat-card-title>
          <mat-card-subtitle>Días disponibles: {{ availableLeaveDays }}</mat-card-subtitle>
        </mat-card-header>

        <form [formGroup]="leaveRequestForm" (ngSubmit)="requestLeave()">
          <mat-card-content class="leave-request-form">
            <mat-date-range-input [formGroup]="leaveRequestForm" [rangePicker]="picker" class="date-range-inputs">
              <input matStartDate formControlName="startDate" placeholder="Fecha inicio" required>
              <input matEndDate formControlName="endDate" placeholder="Fecha fin" required>
            </mat-date-range-input>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-date-range-picker #picker></mat-date-range-picker>

            <mat-error
              *ngIf="leaveRequestForm.controls['startDate'].hasError('required') || leaveRequestForm.controls['endDate'].hasError('required')">
              Ambas fechas son obligatorias.
            </mat-error>
          </mat-card-content>

          <mat-card-actions align="end">
            <button type="submit" mat-flat-button color="primary" [disabled]="leaveRequestForm.invalid">
              <mat-icon>send</mat-icon> Solicitar
            </button>
          </mat-card-actions>
        </form>
      </mat-card>

      <mat-card class="overview-widget">
        <mat-card-header>
          <mat-card-title>Mis Tareas Pendientes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-list *ngIf="employeePendingTasks.length > 0; else noTasks">
            <mat-list-item *ngFor="let task of employeePendingTasks">
              <mat-icon matListItemIcon [ngClass]="'priority-' + task.priority"
                matTooltip="{{task.priority | titlecase}}">flag</mat-icon>
              <div matListItemTitle>{{ task.title }}</div>
            </mat-list-item>
          </mat-list>
          <ng-template #noTasks>
            <p class="no-data-placeholder">¡No tienes tareas pendientes!</p>
          </ng-template>
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-button color="primary" routerLink="/dashboard/tasks">Ver todas mis tareas</button>
        </mat-card-actions>
      </mat-card>

      <mat-card class="overview-widget">
        <mat-card-header>
          <mat-card-title>Próximos Feriados</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-list *ngIf="upcomingHolidays.length > 0; else noHolidays">
            <mat-list-item *ngFor="let holiday of upcomingHolidays">
              <mat-icon matListItemIcon>calendar_today</mat-icon>
              <div matListItemTitle>{{ holiday.name }}</div>
              <div matListItemLine>{{ holiday.date | date:'dd MMM, yyyy' }}</div>
            </mat-list-item>
          </mat-list>
          <ng-template #noHolidays>
            <p class="no-data-placeholder">No hay feriados próximos.</p>
          </ng-template>
        </mat-card-content>
      </mat-card>

    </div>
  </div>

</div>