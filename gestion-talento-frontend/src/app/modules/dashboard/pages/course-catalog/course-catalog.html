<div class="page-container course-catalog-page">

<div class="header-actions-row">
    <app-subpage-header title="Portal de Desarrollo" class="flex-grow"></app-subpage-header>

    <div *ngIf="can(P.TRAINING_MANAGE)" class="view-toggle-container">
      <span class="toggle-label">VISTA:</span>
      <mat-button-toggle-group [(ngModel)]="viewMode" (change)="onViewModeChange()" class="custom-toggle-group">
        <mat-button-toggle value="student" aria-label="Vista Estudiante">
          <div class="toggle-content">
            <mat-icon>school</mat-icon> <span>Estudiante</span>
          </div>
        </mat-button-toggle>
        <mat-button-toggle value="admin" aria-label="Vista Gestor">
          <div class="toggle-content">
            <mat-icon>admin_panel_settings</mat-icon> <span>Gestor LMS</span>
          </div>
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>
  </div>

  <div *ngIf="viewMode === 'student'" class="student-view">

    <mat-tab-group animationDuration="300ms" mat-stretch-tabs="false" mat-align-tabs="start">

      <mat-tab label="Mi Aprendizaje ({{myEnrolledCourses.length}})">
        <div class="tab-content-container" @cardAnimation>

          <h2>Mis Cursos Activos</h2>
          <p class="tab-description">Continúa donde lo dejaste. ¡El aprendizaje constante es la clave del éxito!</p>

          <div class="course-grid">
            <mat-card *ngFor="let course of myEnrolledCourses" class="course-card">
              <img mat-card-image [src]="course.imageUrl" alt="{{course.title}}">

              <mat-card-header>
                <mat-card-title>{{ course.title }}</mat-card-title>
                <mat-card-subtitle>{{ course.instructor }} • {{ course.duration }}</mat-card-subtitle>
              </mat-card-header>

              <mat-card-content class="progress-content">
                <div class="progress-text">
                  Progreso: <strong>{{ course.progress }}%</strong>
                </div>
                <mat-progress-bar mode="determinate" [value]="course.progress"
                  [color]="course.progress === 100 ? 'accent' : 'primary'">
                </mat-progress-bar>
              </mat-card-content>

              <mat-card-actions align="end">
                <button mat-stroked-button color="primary" (click)="continueCourse(course)">
                  {{ course.progress === 100 ? 'Repasar Curso' : 'Continuar' }}
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <div *ngIf="myEnrolledCourses.length === 0" class="no-data-placeholder">
            <mat-icon>school</mat-icon>
            <h3>No tienes cursos activos</h3>
            <p>Explora el catálogo y comienza a aprender hoy mismo.</p>
            <button mat-flat-button color="primary" (click)="selectedCategory = 'todos'; applyFilters()">
              Ir al Catálogo
            </button>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Catálogo de Cursos">
        <div class="tab-content-container">

          <div class="filter-bar">
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>Buscar curso o instructor...</mat-label>
              <input matInput [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()" placeholder="Ej: Liderazgo">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Categoría</mat-label>
              <mat-select [(ngModel)]="selectedCategory" (ngModelChange)="applyFilters()">
                <mat-option value="todos">Todas</mat-option>
                <mat-option *ngFor="let cat of categories" [value]="cat">{{ cat }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="course-grid" @cardAnimation>
            <mat-card *ngFor="let course of filteredCatalogCourses" class="course-card">
              <img mat-card-image [src]="course.imageUrl" alt="{{course.title}}">

              <mat-card-header>
                <mat-card-title>{{ course.title }}</mat-card-title>
                <mat-card-subtitle>{{ course.instructor }} • {{ course.duration }}</mat-card-subtitle>
              </mat-card-header>

              <mat-card-content>
                <p>Domina las habilidades necesarias para destacar en {{ course.category | lowercase }}.</p>
              </mat-card-content>

              <mat-card-actions align="end">
                <button mat-button color="accent">Ver Detalles</button>
                <button mat-flat-button color="primary" (click)="enrollCourse(course)">
                  Inscribirme
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <div *ngIf="filteredCatalogCourses.length === 0" class="no-data-placeholder">
            <mat-icon>search_off</mat-icon>
            <p>No encontramos cursos que coincidan con tu búsqueda.</p>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Mi Plan de Carrera">
        <div class="tab-content-container">

          <h2>Tu Ruta de Crecimiento</h2>
          <p class="tab-description">Sigue estos pasos para alcanzar tu próximo nivel profesional.</p>

          <mat-stepper orientation="vertical" class="career-plan-stepper" [linear]="false" #stepper>
            <mat-step *ngFor="let step of myCareerPlan; let i = index" [completed]="step.status === 'completado'"
              [state]="step.status === 'actual' ? 'edit' : (step.status === 'completado' ? 'done' : 'number')">

              <ng-template matStepLabel>
                <span class="step-label" [class.status-completado]="step.status === 'completado'"
                  [class.status-actual]="step.status === 'actual'"
                  [class.status-siguiente]="step.status === 'pendiente'"> {{ step.name }}
                </span>
                <span *ngIf="step.status === 'actual'" class="current-step-badge">Actual</span>
              </ng-template>

              <div class="step-content">
                <strong>Competencias Clave</strong>
                <ul class="competency-list">
                  <li *ngFor="let comp of step.competencies">{{ comp }}</li>
                </ul>

                <div *ngIf="step.recommendedCourses.length > 0">
                  <strong>Cursos Recomendados</strong>
                  <div class="recommended-courses-grid">
                    <a *ngFor="let course of step.recommendedCourses" class="mini-course-card"
                      (click)="searchTerm = course.title || ''; selectedCategory = 'todos'; applyFilters()">
                      <img mat-card-image [src]="course.imageUrl" alt="{{course.title}}">
                      <mat-card-content>
                        <span class="mini-title">{{ course.title }}</span>
                        <span class="mini-instructor">{{ course.instructor }}</span>
                      </mat-card-content>
                    </a>
                  </div>
                </div>
              </div>
            </mat-step>
          </mat-stepper>

          <div *ngIf="myCareerPlan.length === 0" class="no-data-placeholder">
            <mat-icon>map</mat-icon>
            <h3>No tienes un Plan de Carrera asignado</h3>
            <p>Habla con tu supervisor para definir tu ruta de desarrollo.</p>
          </div>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>

  <div *ngIf="viewMode === 'admin' && can(P.TRAINING_MANAGE)" class="admin-lms-view">

    <mat-tab-group animationDuration="0ms" mat-stretch-tabs="false">

      <mat-tab label="Inventario de Cursos">
        <div class="report-tab-content">

          <div class="tab-action-header">
            <button *ngIf="can(P.TRAINING_MANAGE)" mat-flat-button color="primary" (click)="openCourseDialog()">
              <mat-icon>add</mat-icon> Crear Nuevo Curso
            </button>
          </div>

          <div class="list-container">
            <table mat-table [dataSource]="allCourses" class="admin-course-table">

              <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef> Curso </th>
                <td mat-cell *matCellDef="let course">
                  <span class="course-title">{{ course.title }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="category">
                <th mat-header-cell *matHeaderCellDef> Categoría </th>
                <td mat-cell *matCellDef="let course"> {{ course.category }} </td>
              </ng-container>

              <ng-container matColumnDef="instructor">
                <th mat-header-cell *matHeaderCellDef> Instructor </th>
                <td mat-cell *matCellDef="let course"> {{ course.instructor }} </td>
              </ng-container>

              <ng-container matColumnDef="duration">
                <th mat-header-cell *matHeaderCellDef> Duración </th>
                <td mat-cell *matCellDef="let course"> {{ course.duration }} </td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions"> Acciones </th>
                <td mat-cell *matCellDef="let course" class="actions">
                  <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Opciones">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button *ngIf="can(P.TRAINING_MANAGE)" mat-menu-item (click)="openCourseDialog(course)">
                      <mat-icon>edit</mat-icon> Editar
                    </button>
                    <button *ngIf="can(P.TRAINING_MANAGE)" mat-menu-item (click)="deleteCourse(course)">
                      <mat-icon color="warn">delete</mat-icon> Eliminar
                    </button>
                  </mat-menu>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            <div *ngIf="allCourses.length === 0" class="no-data-placeholder">
              <p>No hay cursos registrados en el sistema.</p>
            </div>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Gestión de Planes de Carrera">
        <div class="report-tab-content">
          <div class="no-data-placeholder">
            <mat-icon style="font-size: 64px; width: 64px; height: 64px;">engineering</mat-icon>
            <h3>Módulo de Gestión de Planes</h3>
            <p>La herramienta para diseñar rutas de aprendizaje estará disponible pronto.</p>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Reportes y Métricas" *ngIf="can(P.REPORTS_VIEW) || can(P.TRAINING_MANAGE)">
        <div class="report-tab-content" @listAnimation>

          <div class="report-widget-grid">

            <mat-card class="report-container chart-widget">
              <mat-card-header>
                <mat-card-title>Top Cursos Completados</mat-card-title>
              </mat-card-header>
              <mat-card-content class="chart-container">
                <ngx-charts-bar-vertical [results]="courseCompletionData" [xAxis]="true" [yAxis]="true"
                  [showXAxisLabel]="true" [showYAxisLabel]="true" yAxisLabel="Empleados" [scheme]="chartColorScheme"
                  [gradient]="false">
                </ngx-charts-bar-vertical>
              </mat-card-content>
            </mat-card>

            <mat-card class="report-container chart-widget">
              <mat-card-header>
                <mat-card-title>Tendencia de Aprendizaje</mat-card-title>
              </mat-card-header>
              <mat-card-content class="chart-container">
                <ngx-charts-line-chart [results]="enrollmentTrendData" [xAxis]="true" [yAxis]="true" [autoScale]="true"
                  [scheme]="chartColorScheme" [showGridLines]="true">
                </ngx-charts-line-chart>
              </mat-card-content>
            </mat-card>

          </div>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>

</div>