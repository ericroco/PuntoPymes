<div class="page-container course-catalog-page">

  <div *ngIf="!viewingAsAdmin">
    <app-subpage-header title="Portal de Desarrollo"></app-subpage-header>

    <mat-tab-group animationDuration="0ms">

      <mat-tab label="Mi Aprendizaje ({{myEnrolledCourses.length}})">
        <div class="tab-content-container" @cardAnimation>
          <p class="tab-description">Cursos en los que estás inscrito actualmente. ¡Sigue así!</p>
          <div class="course-grid">
            <mat-card *ngFor="let course of myEnrolledCourses" class="course-card report-container">
              <img mat-card-image [src]="course.imageUrl" alt="{{course.title}}">
              <mat-card-header>
                <mat-card-title>{{ course.title }}</mat-card-title>
                <mat-card-subtitle>{{ course.instructor }} • {{ course.duration }}</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content class="progress-content">
                <span class="progress-text">{{ course.progress }}% Completado</span>
                <mat-progress-bar mode="determinate" [value]="course.progress"></mat-progress-bar>
              </mat-card-content>
              <mat-card-actions align="end">
                <button mat-flat-button color="primary" (click)="continueCourse(course)">
                  {{ course.progress === 100 ? 'Revisar' : 'Continuar Curso' }}
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
          <div *ngIf="myEnrolledCourses.length === 0" class="no-data-placeholder">
            No estás inscrito en ningún curso. ¡Explora el catálogo!
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Catálogo de Cursos ({{filteredCatalogCourses.length}})">
        <div class="tab-content-container">

          <div class="filter-bar">
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>Buscar por Nombre o Instructor</mat-label>
              <input matInput [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Categoría</mat-label>
              <mat-select [(ngModel)]="selectedCategory" (ngModelChange)="applyFilters()">
                <mat-option value="todos">Todas las Categorías</mat-option>
                <mat-option *ngFor="let cat of categories" [value]="cat">{{ cat }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="course-grid" @cardAnimation>
            <mat-card *ngFor="let course of filteredCatalogCourses" class="course-card report-container">
              <img mat-card-image [src]="course.imageUrl" alt="{{course.title}}">
              <mat-card-header>
                <mat-card-title>{{ course.title }}</mat-card-title>
                <mat-card-subtitle>{{ course.instructor }} • {{ course.duration }}</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
              </mat-card-content>
              <mat-card-actions align="end">
                <button mat-flat-button color="primary" (click)="enrollCourse(course)">
                  <mat-icon>add</mat-icon> Inscribirme
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <div *ngIf="filteredCatalogCourses.length === 0" class="no-data-placeholder">
            No se encontraron cursos con esos filtros.
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Mi Plan de Carrera">
        <div class="tab-content-container">

          <p class="tab-description">
            Esta es tu ruta de crecimiento profesional asignada. ¡Completa las competencias y cursos para avanzar al
            siguiente nivel!
          </p>

          <mat-stepper orientation="vertical" class="career-plan-stepper" [linear]="false" #stepper>

            <mat-step *ngFor="let step of myCareerPlan" [completed]="step.status === 'completado'"
              [state]="step.status === 'actual' ? 'edit' : (step.status === 'completado' ? 'done' : 'number')">

              <ng-template matStepLabel>
                <span class="step-label" [ngClass]="'status-' + step.status">{{ step.name }}</span>
                <span *ngIf="step.status === 'actual'" class="current-step-badge">(Estás Aquí)</span>
              </ng-template>

              <div class="step-content">
                <strong>Competencias a desarrollar:</strong>
                <ul class="competency-list">
                  <li *ngFor="let comp of step.competencies">{{ comp }}</li>
                </ul>

                <div *ngIf="step.recommendedCourses.length > 0">
                  <strong>Cursos Recomendados para este paso:</strong>
                  <div class="recommended-courses-grid">

                    <mat-card *ngFor="let course of step.recommendedCourses" class="mini-course-card"
                      routerLink="/dashboard/course-catalog" [queryParams]="{ tab: 1, search: course.title }"
                      matTooltip="Ir al Catálogo y buscar este curso">
                      <img mat-card-image [src]="course.imageUrl" alt="{{course.title}}">
                      <mat-card-content>
                        <span class="mini-title">{{ course.title }}</span>
                        <span class="mini-instructor">{{ course.instructor }}</span>
                      </mat-card-content>
                    </mat-card>

                  </div>
                </div>
              </div>

            </mat-step>
          </mat-stepper>

          <div *ngIf="myCareerPlan.length === 0" class="no-data-placeholder">
            Aún no tienes un Plan de Carrera asignado. Habla con tu supervisor.
          </div>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>

  <div *ngIf="viewingAsAdmin" class="admin-lms-view">
    <app-subpage-header title="Gestión de Capacitación (LMS)"></app-subpage-header>

    <mat-tab-group animationDuration="0ms">

      <mat-tab label="Gestión de Cursos">
        <div class="report-tab-content">
          <div class="tab-action-header">
            <button mat-flat-button color="primary" (click)="openCourseDialog()">
              <mat-icon>add</mat-icon>
              Crear Nuevo Curso
            </button>
          </div>

          <div class="list-container">
            <table mat-table [dataSource]="catalogCourses" class="admin-course-table">

              <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef> Título del Curso </th>
                <td mat-cell *matCellDef="let course">
                  <span class="course-title">{{ course.title }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="category">
                <th mat-header-cell *matHeaderCellDef> Categoría </th>
                <td mat-cell *matCellDef="let course"> {{ course.category }} </td>
              </ng-container>

              <ng-container matColumnDef="instructor">
                <th mat-header-cell *matHeaderCellDef> Instructor </th>
                <td mat-cell *matCellDef="let course"> {{ course.instructor }} </td>
              </ng-container>

              <ng-container matColumnDef="duration">
                <th mat-header-cell *matHeaderCellDef> Duración </th>
                <td mat-cell *matCellDef="let course"> {{ course.duration }} </td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef> Acciones </th>
                <td mat-cell *matCellDef="let course" class="actions">
                  <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Acciones">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="openCourseDialog(course)">
                      <mat-icon>edit</mat-icon>
                      <span>Editar Curso</span>
                    </button>
                    <button mat-menu-item (click)="deleteCourse(course)">
                      <mat-icon color="warn">delete_outline</mat-icon>
                      <span>Eliminar Curso</span>
                    </button>
                  </mat-menu>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            <div *ngIf="catalogCourses.length === 0" class="no-data-placeholder">
              No hay cursos definidos.
            </div>
          </div>

        </div>
      </mat-tab>

      <mat-tab label="Gestión de Planes de Carrera">
        <div class="report-tab-content">
          <app-career-paths></app-career-paths>
        </div>
      </mat-tab>

      <mat-tab label="Reportes">
        <div class="report-tab-content" @listAnimation>
          <div class="report-widget-grid">
            <mat-card class="overview-widget chart-widget report-container">
              <mat-card-header>
                <mat-card-title>Cursos Más Completados</mat-card-title>
              </mat-card-header>
              <mat-card-content class="chart-container">
                <ngx-charts-bar-vertical [results]="courseCompletionData" [xAxis]="true" [yAxis]="true"
                  [showXAxisLabel]="false" [showYAxisLabel]="true" yAxisLabel="Nº Empleados"
                  [scheme]="chartColorScheme">
                </ngx-charts-bar-vertical>
              </mat-card-content>
            </mat-card>

            <mat-card class="overview-widget chart-widget report-container">
              <mat-card-header>
                <mat-card-title>Nuevas Inscripciones (Últ. Meses)</mat-card-title>
              </mat-card-header>
              <mat-card-content class="chart-container">
                <ngx-charts-line-chart [results]="enrollmentTrendData" [xAxis]="true" [yAxis]="true" [autoScale]="true"
                  [scheme]="chartColorScheme">
                </ngx-charts-line-chart>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>

</div>