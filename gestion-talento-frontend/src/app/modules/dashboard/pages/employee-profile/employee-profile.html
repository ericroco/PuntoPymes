<div class="page-container" *ngIf="employee; else loading">
  <header class="profile-header">
    <img [src]="employee.avatar" alt="Avatar" class="avatar">
    <div class="info">
      <h1>{{ employee.name }}</h1>
      <p>{{ employee.role }} | {{ employee.department }}</p>
    </div>

    <button *ngIf="!viewingAsAdmin" mat-stroked-button color="primary" class="edit-contact-btn"
      (click)="openEditContactInfoDialog()">
      <mat-icon>edit</mat-icon> <span>Editar Contacto</span>
    </button>
    <button *ngIf="viewingAsAdmin" mat-stroked-button color="primary" class="edit-profile-btn"
      (click)="openEditProfileDialog()">
      <mat-icon>manage_accounts</mat-icon> Editar Perfil (Admin)
    </button>
    <button *ngIf="viewingAsAdmin" class="btn btn-secondary">Exportar Perfil a PDF</button>
  </header>
  <section class="details-section general-info-section">
    <h3>Informaci√≥n General</h3>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">Correo Electr√≥nico:</span>
        <span class="info-value">{{ employee.email || '---' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Tel√©fono / Celular:</span>
        <span class="info-value">{{ employee.phone || '---' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Fecha de Contrataci√≥n:</span>
        <span class="info-value">{{ employee.hireDate ? (employee.hireDate | date:'longDate') : '---' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Reporta a:</span>
        <span class="info-value">{{ employee.reportsTo || '---' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Direcci√≥n:</span>
        <span class="info-value">{{ employee.address || '---' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Contacto de Emergencia:</span>
        <span class="info-value">{{ employee.emergencyContact || '---' }}</span>
      </div>
    </div>
  </section>
  <section class="details-section schedule-section" *ngIf="viewingAsAdmin">
    <div class="section-header">
      <h3>Horario Asignado</h3>
      <button mat-stroked-button color="primary" (click)="openEditScheduleDialog()">
        <mat-icon>edit_calendar</mat-icon>
        Editar Horario
      </button>
    </div>
    <div class="schedule-summary">
      <p><strong>Tipo:</strong> {{ assignedSchedule.type }}</p>
      <p *ngIf="assignedSchedule.type !== 'Est√°ndar'">
        <strong>D√≠as:</strong> {{ assignedSchedule.days.join(', ') }}
      </p>
      <p><strong>Horas:</strong> {{ assignedSchedule.startTime }} - {{ assignedSchedule.endTime }}</p>
    </div>
  </section>

  <section class="kpi-grid" *ngIf="viewingAsAdmin">
    <div *ngFor="let kpi of kpis" class="kpi-card">
      <span class="kpi-label">{{ kpi.label }}</span>
      <span class="kpi-value">{{ kpi.value }}</span>
    </div>
  </section>

  <section class="details-section custom-fields-section">
    <h3>Informaci√≥n Adicional</h3>
    <div class="custom-fields-grid" *ngIf="definedCustomFields.length > 0; else noCustomFields">
      <div *ngFor="let field of definedCustomFields" class="field-item">
        <span class="field-label">{{ field.label }}:</span>
        <span class="field-value">
          {{ employee.customFields && employee.customFields[field.key] ?
          (field.type === 'date' ? (employee.customFields[field.key] | date:'longDate') :
          employee.customFields[field.key])
          : '---' }}
        </span>
      </div>
    </div>
    <ng-template #noCustomFields>
      <p class="no-data-placeholder">No hay campos personalizados definidos.</p>
    </ng-template>
  </section>
  <section class="details-section salary-section" *ngIf="viewingAsAdmin">
    <h3>Historial Salarial y Compensaci√≥n</h3>
    <div class="document-list" *ngIf="salaryHistory.length > 0; else noSalaryHistory">
      <div class="document-item header">
        <span>Fecha</span>
        <span>Tipo de Movimiento</span>
        <span>Monto (USD)</span>
        <span class="comments">Comentarios</span>
      </div>
      <div *ngFor="let item of salaryHistory" class="document-item">
        <span>{{ item.date | date:'dd MMM, yyyy' }}</span>
        <span>{{ item.type }}</span>
        <span class="salary">{{ item.amount | currency:'USD':'symbol':'1.2-2' }}</span>
        <span class="comments">{{ item.comments }}</span>
      </div>
    </div>
    <ng-template #noSalaryHistory>
      <p class="no-data-placeholder">No hay historial salarial registrado.</p>
    </ng-template>
  </section>

  <div class="details-grid">
    <div class="details-section goals-section">
      <h3>Metas Asignadas</h3>
      <div class="goals-list" *ngIf="goals.length > 0; else noGoals">
        <div *ngFor="let goal of goals" class="goal-card">
          <h4 class="goal-title">{{ goal.title }}</h4>
          <div class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="goal.progress" [style.background-color]="goal.statusColor"></div>
          </div>
          <span class="progress-text">{{ goal.progress }}% completado</span>
        </div>
      </div>
      <ng-template #noGoals>
        <p class="no-data-placeholder">No hay metas asignadas actualmente.</p>
      </ng-template>
    </div>

    <div class="details-section evaluation-section" *ngIf="viewingAsAdmin">
      <h3>Evaluaci√≥n del Administrador</h3>
      <div class="evaluation-form">
        <textarea placeholder="A√±adir notas sobre el desempe√±o..." [(ngModel)]="evaluationNotes"></textarea>
        <div class="recommendation">
          <label>Recomendaci√≥n:</label>
          <select [(ngModel)]="recommendation">
            <option>Mantener Posici√≥n</option>
            <option>Considerar para Aumento</option>
            <option>Considerar para Ascenso</option>
          </select>
        </div>
        <button class="btn btn-primary" (click)="saveEvaluation()">Guardar Evaluaci√≥n</button>
      </div>
    </div>
  </div>
  <section class="details-section document-section">
    <div class="section-header">
      <h3>Gesti√≥n de Documentos</h3>
      <div class="filter-controls">
        <label for="doc-type-filter">Filtrar por tipo:</label>
        <select id="doc-type-filter" class="filter-select">
          <option value="todos">Todos los tipos</option>
          <option value="Certificaci√≥n Externa">Certificaci√≥n Externa</option>
          <option value="Capacitaci√≥n Interna">Capacitaci√≥n Interna</option>
          <option value="Documento Legal">Documento Legal</option>
          <option value="Reconocimiento Interno">Reconocimiento Interno</option>
        </select>
      </div>
      <button *ngIf="!viewingAsAdmin" class="btn btn-secondary" (click)="openAddDocumentDialog()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path
            d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
        </svg>
        <span>A√±adir Documento</span>
      </button>
    </div>
    <div class="document-list">
      <div class="document-item header">
        <span>Nombre del Archivo / Certificado</span>
        <span>Tipo</span>
        <span>Origen</span>
        <span>Fecha</span>
        <span>Acciones</span>
      </div>
      <div *ngFor="let doc of unifiedDocuments" class="document-item">
        <div class="file-info">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M3 3.5A1.5 1.5 0 014.5 2h6.879a1.5 1.5 0 011.06.44l4.122 4.12A1.5 1.5 0 0117 7.622V16.5A1.5 1.5 0 0115.5 18h-11A1.5 1.5 0 013 16.5v-13zM11.5 2.5v1.625c0 .414.336.75.75.75H14.5v.001l-3-3z"
              clip-rule="evenodd" />
          </svg>
          <span>{{ doc.name }}</span>
        </div>
        <span>{{ doc.type }}</span>
        <td> <span class="origin-badge" [ngClass]="doc.origin === 'Empresa' ? 'origin-empresa' : 'origin-empleado'">
            {{ doc.origin }}
          </span>
        </td>
        <span>{{ doc.date | date:'dd MMM, yyyy' }}</span>
        <div class="actions">
          <button class="btn-icon" title="Descargar">üì•</button>
          <button *ngIf="viewingAsAdmin || (!viewingAsAdmin && doc.origin === 'Empleado')" class="btn-icon btn-danger"
            (click)="deleteDocument(doc)" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
      <div *ngIf="unifiedDocuments.length === 0" class="empty-list-placeholder list-item">
        No hay documentos asociados.
      </div>
    </div>
  </section>



</div> <ng-template #loading>
  <div class="loading-container">
    <p>Cargando perfil del empleado...</p>
  </div>
</ng-template>