<div class="page-container" *ngIf="employee; else loading">

  <header class="profile-header">
    <div class="avatar-wrapper">
      <img *ngIf="employee.fotoUrl" [src]="employee.fotoUrl" alt="Avatar" class="avatar-img"
        onerror="this.style.display='none'">
      <div *ngIf="!employee.fotoUrl" class="avatar-placeholder">
        {{ getInitials(employee.nombre, employee.apellido) }}
      </div>

      <div class="avatar-overlay" *ngIf="canEditContact" (click)="openEditAvatarDialog()">
        <mat-icon>camera_alt</mat-icon>
        <span>Editar</span>
      </div>
    </div>

    <div class="info">
      <h1>{{ employee.nombre }} {{ employee.apellido }}</h1>
      <p class="job-title">
        {{ employee.cargo?.nombre || 'Sin Cargo' }}
        <span *ngIf="employee.cargo?.departamento?.nombre"> | {{ employee.cargo!.departamento!.nombre }}</span>
      </p>
      <span class="status-badge"
        [ngClass]="{'active': employee.estado === 'Activo', 'inactive': employee.estado !== 'Activo'}">
        {{ employee.estado }}
      </span>
    </div>

    <button *ngIf="canEditContact" mat-stroked-button color="primary" class="edit-contact-btn"
      (click)="openEditContactInfoDialog()">
      <mat-icon>edit</mat-icon> <span>Editar Contacto</span>
    </button>

    <button *ngIf="canEditSensitive" mat-stroked-button color="primary" class="edit-profile-btn"
      (click)="openEditProfileDialog()">
      <mat-icon>manage_accounts</mat-icon> Editar Perfil (Admin)
    </button>

    <button *ngIf="can(P.EMPLOYEES_EXPORT)" class="btn btn-secondary">Exportar Perfil a PDF</button>
  </header>

  <section class="details-section general-info-section">
    <h3>Informaci贸n General</h3>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">Correo Personal:</span>
        <span class="info-value">{{ employee.emailPersonal || '---' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Tel茅fono / Celular:</span>
        <span class="info-value">{{ employee.telefono || '---' }}</span>
      </div>

      <div class="info-item" *ngIf="can(P.ROLES_MANAGE)">
        <span class="info-label">Rol de Sistema:</span>
        <span class="info-value">{{ employee.rol?.nombre || '---' }}</span>
      </div>

      <div class="info-item">
        <span class="info-label">Direcci贸n:</span>
        <span class="info-value">{{ employee.direccion || '---' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Fecha Nacimiento:</span>
        <span class="info-value">{{ employee.fechaNacimiento ? (employee.fechaNacimiento | date:'longDate') : '---'
          }}</span>
      </div>
    </div>
  </section>

  <section class="details-section schedule-section" *ngIf="can(P.ATTENDANCE_APPROVE) || can(P.EMPLOYEES_EDIT)">
    <div class="section-header">
      <h3>Horario Asignado</h3>
      <button *ngIf="can(P.EMPLOYEES_EDIT)" mat-stroked-button color="primary" (click)="openEditScheduleDialog()">
        <mat-icon>edit_calendar</mat-icon>
        Editar Horario
      </button>
    </div>
    <div class="schedule-summary" *ngIf="assignedSchedule">
      <p><strong>Tipo:</strong> {{ assignedSchedule.type }}</p>
      <p *ngIf="assignedSchedule.type !== 'Est谩ndar'">
        <strong>D铆as:</strong> {{ assignedSchedule.days.join(', ') }}
      </p>
      <p><strong>Horas:</strong> {{ assignedSchedule.startTime }} - {{ assignedSchedule.endTime }}</p>
    </div>
  </section>

  <section class="kpi-grid" *ngIf="can(P.PERFORMANCE_MANAGE)">
    <div *ngFor="let kpi of kpis" class="kpi-card">
      <span class="kpi-label">{{ kpi.label }}</span>
      <span class="kpi-value">{{ kpi.value }}</span>
    </div>
  </section>

  <section class="details-section custom-fields-section" *ngIf="definedCustomFields.length > 0">
    <h3>Informaci贸n Adicional</h3>
    <div class="custom-fields-grid">
      <div *ngFor="let field of definedCustomFields" class="field-item">
        <span class="field-label">{{ field.label }}:</span>
        <span class="field-value">---</span>
      </div>
    </div>
  </section>

  <section class="details-section salary-section" *ngIf="can(P.PAYROLL_READ)">
    <h3>Historial Salarial y Compensaci贸n</h3>
    <div class="document-list" *ngIf="salaryHistory.length > 0; else noSalaryHistory">
      <div class="document-item header">
        <span>Fecha</span>
        <span>Tipo de Movimiento</span>
        <span>Monto (USD)</span>
        <span class="comments">Comentarios</span>
      </div>
      <div *ngFor="let item of salaryHistory" class="document-item">
        <span>{{ item.date | date:'dd MMM, yyyy' }}</span>
        <span>{{ item.type }}</span>
        <span class="salary">{{ item.amount | currency:'USD':'symbol':'1.2-2' }}</span>
        <span class="comments">{{ item.comments }}</span>
      </div>
    </div>
    <ng-template #noSalaryHistory>
      <p class="no-data-placeholder">No hay historial salarial registrado.</p>
    </ng-template>
  </section>

  <div class="details-grid">
    <div class="details-section goals-section">
      <h3>Metas Asignadas</h3>
      <div class="goals-list" *ngIf="goals.length > 0; else noGoals">
        <div *ngFor="let goal of goals" class="goal-card">
          <h4 class="goal-title">{{ goal.title }}</h4>
          <div class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="goal.progress" [style.background-color]="goal.statusColor"></div>
          </div>
          <span class="progress-text">{{ goal.progress }}% completado</span>
        </div>
      </div>
      <ng-template #noGoals>
        <p class="no-data-placeholder">No hay metas asignadas actualmente.</p>
      </ng-template>
    </div>

    <div class="details-section evaluation-section" *ngIf="can(P.PERFORMANCE_MANAGE) && !isMyProfile">
      <h3>Evaluaci贸n del Administrador</h3>
      <div class="evaluation-form">
        <textarea placeholder="A帽adir notas sobre el desempe帽o..." [(ngModel)]="evaluationNotes"></textarea>
        <div class="recommendation">
          <label>Recomendaci贸n:</label>
          <select [(ngModel)]="recommendation">
            <option>Mantener Posici贸n</option>
            <option>Considerar para Aumento</option>
            <option>Considerar para Ascenso</option>
          </select>
        </div>
        <button class="btn btn-primary" (click)="saveEvaluation()">Guardar Evaluaci贸n</button>
      </div>
    </div>
  </div>

  <section class="details-section document-section">
    <div class="section-header">
      <h3>Gesti贸n de Documentos</h3>
      <div class="filter-controls">
        <label for="doc-type-filter">Filtrar por tipo:</label>
        <select id="doc-type-filter" class="filter-select">
          <option value="todos">Todos los tipos</option>
          <option value="Certificaci贸n Externa">Certificaci贸n Externa</option>
          <option value="Capacitaci贸n Interna">Capacitaci贸n Interna</option>
          <option value="Documento Legal">Documento Legal</option>
          <option value="Reconocimiento Interno">Reconocimiento Interno</option>
        </select>
      </div>
      <button *ngIf="canEditContact || can(P.DOCUMENTS_MANAGE)" class="btn btn-secondary"
        (click)="openAddDocumentDialog()">
        <mat-icon>upload_file</mat-icon>
        <span>A帽adir Documento</span>
      </button>
    </div>

    <div class="document-list">
      <div class="document-item header">
        <span>Nombre del Archivo</span>
        <span>Tipo</span>
        <span>Origen</span>
        <span>Fecha</span>
        <span>Acciones</span>
      </div>
      <div *ngFor="let doc of unifiedDocuments" class="document-item">
        <div class="file-info">
          <mat-icon>description</mat-icon>
          <span>{{ doc.name }}</span>
        </div>
        <span>{{ doc.type }}</span>
        <td>
          <span class="origin-badge" [ngClass]="doc.origin === 'Empresa' ? 'origin-empresa' : 'origin-empleado'">
            {{ doc.origin }}
          </span>
        </td>
        <span>{{ doc.date | date:'dd MMM, yyyy' }}</span>
        <div class="actions">
          <button class="btn-icon" title="Descargar" (click)="downloadDocument(doc)">
             </button>

          <button *ngIf="doc.canDelete && can(P.DOCUMENTS_MANAGE)" class="btn-icon btn-danger"
            (click)="deleteDocument(doc)" title="Eliminar">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
      <div *ngIf="unifiedDocuments.length === 0" class="empty-list-placeholder list-item">
        No hay documentos asociados.
      </div>
    </div>
  </section>

</div>

<ng-template #loading>
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando perfil...</p>
  </div>
</ng-template>