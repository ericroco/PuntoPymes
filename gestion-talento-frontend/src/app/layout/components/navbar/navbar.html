<header class="navbar-container">

  <div class="navbar-left">
    <button class="menu-btn mobile-only" mat-icon-button>
      <mat-icon>menu</mat-icon>
    </button>

    <div class="page-context">
      <h1>{{ 'NAVBAR.TITLE' | translate }}</h1>

      <div class="context-subtitle">
        <span *ngIf="!selectedBranchId" class="welcome-msg fade-in">
          {{ 'NAVBAR.WELCOME' | translate }} <strong>{{ displayName | titlecase }}</strong>
        </span>

        <div *ngIf="selectedBranchId" class="filter-badge fade-in">
          <span class="dot"></span>
          <span>{{ 'NAVBAR.FILTERING_BADGE' | translate }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="navbar-actions">

    <div class="action-group branch-wrapper" *ngIf="canSwitchBranch">
      <mat-form-field appearance="outline" class="branch-select-field">
        <mat-select [value]="selectedBranchId" (selectionChange)="onBranchChange($event.value)"
          [placeholder]="'NAVBAR.ALL_BRANCHES' | translate">

          <mat-select-trigger>
            <div class="trigger-content">
              <mat-icon class="trigger-icon">store</mat-icon>
              <span class="trigger-text">{{ getBranchName(selectedBranchId) || ('NAVBAR.ALL_BRANCHES' | translate)
                }}</span>
            </div>
          </mat-select-trigger>

          <mat-option [value]="null">
            <mat-icon>domain</mat-icon> {{ 'NAVBAR.ALL_BRANCHES' | translate }}
          </mat-option>
          <mat-option *ngFor="let b of branches" [value]="b.id">
            <mat-icon>store_mall_directory</mat-icon> {{ b.nombre }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="action-group search-wrapper">
      <div class="search-box">
        <mat-icon class="search-icon">search</mat-icon>
        <input type="text" [placeholder]="'NAVBAR.SEARCH_PLACEHOLDER' | translate" class="search-input">
      </div>
    </div>

    <div class="divider-vertical"></div>

    <div class="action-group">
      <button mat-icon-button [matMenuTriggerFor]="langMenu" matTooltip="Idioma / Language">
        <span style="font-weight: 700; font-size: 0.85rem;">
          {{ (configService.config$ | async)?.lang | uppercase }}
        </span>
      </button>
      <mat-menu #langMenu="matMenu">
        <button mat-menu-item (click)="configService.setLanguage('es')">
          <span>ðŸ‡ªðŸ‡¸ EspaÃ±ol</span>
        </button>
        <button mat-menu-item (click)="configService.setLanguage('en')">
          <span>ðŸ‡ºðŸ‡¸ English</span>
        </button>
      </mat-menu>
    </div>

    <div class="action-group">
      <button mat-icon-button (click)="configService.toggleTheme()"
        [matTooltip]="((configService.config$ | async)?.theme === 'dark' ? 'NAVBAR.THEME.LIGHT' : 'NAVBAR.THEME.DARK') | translate">

        <mat-icon *ngIf="(configService.config$ | async)?.theme === 'dark'"
          class="theme-icon-anim">light_mode</mat-icon>

        <mat-icon *ngIf="(configService.config$ | async)?.theme === 'light'"
          class="theme-icon-anim">dark_mode</mat-icon>
      </button>
    </div>

    <div class="action-group">
      <button mat-icon-button class="notification-btn" [matMenuTriggerFor]="notificationMenu">
        <mat-icon>notifications_none</mat-icon>
        <span class="notification-dot" *ngIf="notificationCount > 0"></span>
      </button>
    </div>

    <div class="user-profile-wrapper">
      <div class="user-card" [matMenuTriggerFor]="userMenu">
        <div class="user-info">
          <span class="name">{{ displayName | titlecase }}</span>
          <span class="role">{{ userRole }}</span>
        </div>
        <div class="avatar-container">
          <img [src]="userAvatar" [alt]="'NAVBAR.AVATAR_ALT' | translate" class="avatar"
            onerror="this.src='assets/images/default-avatar.png'">
        </div>
      </div>
    </div>

  </div>
</header>

<mat-menu #notificationMenu="matMenu" xPosition="before" class="notification-panel">
  <div class="notification-header">
    <h3>{{ 'NOTIFICATIONS.TITLE' | translate }}</h3>
    <button mat-button color="primary" (click)="markAllRead()">{{ 'NOTIFICATIONS.MARK_ALL_READ' | translate }}</button>
  </div>
  <div class="notification-list">
    <button mat-menu-item *ngFor="let notif of notifications" class="notification-item" [class.unread]="!notif.read">
      <div class="notif-icon-box" [style.color]="notif.color || 'var(--color-primary)'">
        <mat-icon>{{ notif.icon }}</mat-icon>
      </div>
      <div class="notif-content">
        <span class="notif-title">{{ notif.title }}</span>
        <span class="notif-time">{{ notif.time }}</span>
      </div>
    </button>
    <div *ngIf="notifications.length === 0" class="empty-notif">
      <mat-icon>notifications_off</mat-icon>
      <p>{{ 'NOTIFICATIONS.EMPTY_STATE' | translate }}</p>
    </div>
  </div>
</mat-menu>

<mat-menu #userMenu="matMenu" xPosition="before">
  <button mat-menu-item routerLink="/dashboard/my-profile">
    <mat-icon>account_circle</mat-icon> {{ 'USER_MENU.PROFILE' | translate }}
  </button>
  <button mat-menu-item routerLink="/dashboard/settings">
    <mat-icon>settings</mat-icon> {{ 'USER_MENU.SETTINGS' | translate }}
  </button>
  <mat-divider></mat-divider>
  <button mat-menu-item (click)="logout()">
    <mat-icon color="warn">logout</mat-icon> {{ 'USER_MENU.LOGOUT' | translate }}
  </button>
</mat-menu>